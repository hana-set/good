---
title:  "메모리 구조"
excerpt: "메모리의 구조"
categories:
  - Others
tags:
  - 3
last_modified_at: 2021-06-26

toc: true
toc_label: "Table Of Contents"
toc_icon: "cog"
toc_sticky: true

use_math : true
---

<br>

# <center><font size="15">메모리</font></center>

![png](/assets/images/Others/1_1.png)

- 위와 같이 프로그램이 실행되려면 운영체제가 프로그램의 정보를 메모리에 로드해야합니다.
- 또한 실행되는동안 CPU 코드를 처리하기 위해서는 메모리가 명령어와 데이터를 저장해야합니다. 

![png](/assets/images/Others/1_2.png)

- 위와 같이 프로그램이 운영체제로부터 할당받는 메모리공간은 4개의 영역으로 쪼개집니다. 

<br>

## 코드영역

- 코드영역은 실행할 프로그램의 코드가 저장되는 영역입니다. 
- CPU 는 코드영역에 저장된 명령을 하나씩 가져가서 처리하게됩니다. 

<br>

## 데이터 영역

- 데이터영역은 프로그램의 전역변수와 정적변수가 저장되는 영역입니다. 
  - 전역변수/정적변수는 LIfetime 은 동일합니다. 즉 해당 프로그램이 죽을떄까지 유지됩니다.
  - 전역변수는 해당 프로그램의 어떠한 함수/ 파일에서 모두 사용 가능합니다.
  - 정적변수는 변수가 선언된 파일이나 함수 내에서만 접근이 가능합니다. 
  - 이때에 주의할점은 한번 선언된 값은 프로그램이 끝날떄까지 유지되므로, 보안이 중요할 경우 매번 프로그램을 초기화 해야할 것입니다. (사족임..)

<br>

## 힙 영역

- 프로그래머가 직접 공간을 할당 , 해제하는 메모리 공간입니다. 
- 힙 영역은 빈 공간입니다. 필요에 의해 메모리를 할당하기도 하고 해제하기도 합니다.
  - 그런데 스택 영역을 쓰면 되지, 힙 영역을 왜 사용할까요??
  - 힙은 데이터 영역이나 스택 영역에서 관리하는 형태 이외의 데이터 형태를 다룹니다. 그것은 바로 동적 할당! 컴파일 시기에 크기를 알 수 없는 데이터!
  - 컴파일 할 때는 크기를 알지 못 하다가, 프로그램이 실행되었을 때 크기가 결정되는 경우입니다. 
  - 그러므로 힙을 사용합니다. 

- 힙 영역의 크기는 프로그램이 실행되는 도중인 런타임(run time)에 사용자가 직접 결정하게 됩니다. 반면에 데이터 영역과 스택 영역의 메모리 크기는 컴파일 타임에 미리 결정됩니다.

>예를 들어, 게임의 회원수가 1000명이지만 동시 접속자 수는 그 중 10%, 100명 정도인 게임을 운영하는 게임 회사가 있습니다. 
>게임의 회원수가 1000명이라고 하여 1000명분의 메모리를 고정적으로 지정하면 그 중 10프로만 메모리가 사용되어지고 나머지 90%는 사용되어지지 않은 채 메모리 공간만 잡아먹게 되어 시간과 비용적으로 비생산적이고 비효율적이게 됩니다. 
>하지만 회원이 게임을 접속할때만(프로그램이 실행되는 도중인 run time때) 동적 할당을 사용하게 되면 사용자가 게임을 접속할 때 필요한 메모리만 할당하게 됩니다. 
>그렇게 되면 더욱 효율적이고 생산적으로 메모리를 관리할 수 있게 됩니다.

- 이러한 이유로 동적 할당으로 힙 영역을 적절한 곳에 사용하게 된다면 메모리의 낭비 없이 생산적으로 메모리를 할당할 수 있게 됩니다. 런타임에 메모리가 할당받는 것을 메모리의 동적 할당(dynamic allocation)이라고 합니다.

<br>

## 스택 영역

- 지역변수와 매개변수를 저장하는 공간입니다. 
  - 매개변수(parameter)
    - 함수가 외부로부터 전달받는 데이터를 가지고 있는 변수
    - def f(x,y) :  ..... 에서 x,y 에 해당한다. 
  - 지역변수(local variable)
    - 함수 안에서 정의되는 변수 
    - def f(x,y) : a=0 , ..... 에서 a 에 해당한다. 
- 이 영역에 저장되는 함수의 호출 정보를 스택 프래임이라 합니다. 
  - 이름에 걸맞게 푸시로 데이터를 저장하고 pop 으로 인출하는 stack 의 형태입니다. 
  - 즉 LIFO 구조로, 제일 최근에 추가한 함수가 제일 먼저 제거(실행) 되는 형태입니다. 

![png](/assets/images/Others/1_6.png)

![png](/assets/images/Others/1_7.png)

- 위와 같이, 함수가 Stack 처럼 쌓이며, 호출될때에는 위의것부터 호출됩니다. 

<br>

## 힙과 스택의 메모리 적재

![png](/assets/images/Others/1_9.png)

- 힙과 스택은 메모리를 적재하는 방식이 약간 다릅니다.
  - Stack 은 큰 주소값을 시작으로 점차 주소값이 작아집니다.
  - Heap 은 작은 주소값을 기준으로 점차 커집니다. 
- 위와 같이 설정하여, 버퍼 오버플로우(데이터가 초과하여 넘치는현상)를 미연에 방지하는 것입니다. 
  - 하지만 데이터를 계속 넣다보면 언젠가 서로 겹치겠죠? 이와 같은 문제를 오버플로우라 하며, 어떻게 다루는지 아래에서 알아봅시다.

<br>

# <center><font size="15">오버플로우</font></center>

- 오버플로우란 아래 그림과 같이 한정된 메모리 공간이 부족해 메모리 안의 데이터가 넘쳐 흐르는 현상입니다.

![png](/assets/images/Others/1_10.png)

![png](/assets/images/Others/1_5.png)

- 힙과 스택은 서로 부딫히는 방향으로 메모리가 적재되기 때문에, 어느순간 겹칠 수 있습니다. 
- 이떄에 힙이 스탭을 침범하는경우가 힙 오버플로우라 하도, 스택이 힙을 침범하는 경우를 스택 오버 플로우 라고 합니다. 

<br>

## Stack Overflow

- 재귀 호출이 무한히 반복되면 어떡할까요?
- 그렇다면 해당 프로그램을 스택 오버플로우(스택에 한계를 넘어 쌓여버림) 가 발생합니다. 

![png](/assets/images/Others/1_8.png)

<br>

## 힙 오버플로우

- 힙이 스택을 침범하는 경우입니다. 
- 힙 영역에 할당된 크기를 초과하는 데이터를 쓰려고 할 떄에, 스택을 침범하여 발생할 수 있습니다. 

<br>

# <center><font size="15">파이썬의 메모리사용?</font></center>

- C, C++, 또는 Java의 경우 malloc과 같은 함수를 이용해서 동적할당을 사용할 수 있게 됩니다. 
- 하지만, 놀랍게도 파이썬은 동적 할당의 기능이 없습니다. 이 말은 즉, 사용자가 직접 메모리 할당범위를 조정하지 않습니다. 왜냐하면 파이썬은 자동으로 메모리를 관리해주는 언어이기 때문입니다.
- 그럼 파이썬은 스택 영역만 사용하게 되는가, 그렇지 않습니다. 파이썬은 메모리를 관리해주는 특별한 기능이 있습니다. Python Memory Manager라는 기능인데요, 이 기능이 포인터를 움직여 힙 영역의 메모리 할당 범위와 내부 버퍼를 조정해줍니다.
- 파이썬에서 메모리의 동적 할당은 C와 다르게(C는 메모리 집중(Memory Oriented) 언어) 그리 중요하지 않습니다
- 힙 안의 메모리 영역을 interpreter가 포인터를 사용해 영역의 범위를 조정함으로써, interpreter가 자동으로 메모리를 OS로 할당하지 않고 가지고 있다가 사용될 때 메모리를 재사용 하는 방식으로 운영됩니다. 즉, 메모리 할당에 있어 OS의 과부하를 줄여주는 획기적인 High level language입니다. 



# Reference

- https://pangate.com/541
- https://armontad-1202.tistory.com/entry/%ED%8C%8C%EC%9D%B4%EC%8D%AC%EC%9D%98-%EB%A9%94%EB%AA%A8%EB%A6%AC-%EC%98%81%EC%97%AD
- https://bpsecblog.wordpress.com/2016/10/06/heap_vuln/

